<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${manga.mangaName}"></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="/images/icons/MangaLibraryLogo.png">
    <link rel="stylesheet" href="/css/manga-details.css">
    <link rel="stylesheet" href="/css/manga-details-animation.css">
    <link rel="stylesheet" href="/css/loader.css">
    <link rel="stylesheet" href="/css/main/custom-select.css">
    <meta name="_csrf" th:content="${_csrf.token}" />
</head>
<body class="loading">
<div class="content">
<div th:insert="~{blocks/loader :: loader}"></div>
<header th:insert="~{blocks/header :: header}"></header>
<div th:insert="~{blocks/modals/adultContentModal :: adultContentModal}"></div>
<div th:insert="~{blocks/modals/deleteConfirmationModal :: deleteConfirmationModal}"></div>
<div th:insert="~{blocks/modals/deleteReplyModal :: deleteReplyModal}"></div>
<div th:insert="~{blocks/modals/errorModal :: errorModal}"></div>
<div th:insert="~{blocks/modals/reportCommentModal :: reportCommentModal}"></div>
<div th:insert="~{blocks/modals/reportReplyModal :: reportReplyModal}"></div>
<div th:insert="~{blocks/modals/successModal :: successModal}"></div>

<div class="container mt-5 mb-5">
    <div class="bg-manga">
        <img th:src="${manga.mangaBackGround}" alt="" class="img-fluid">
    </div>
    <div class="main-container">
        <div class="left-block">
            <div class="manga-image-container">
                <img th:src="${manga.mangaPosterImg}" alt="Main Manga Image">
                <form id="addMangaFavoritesForm" action="#" th:action="@{/manga/add-to-favorites}" method="post" onsubmit="return false;">
                    <input type="hidden" name="mangaId" th:value="${manga.id}" />
                    <button type="submit" id="addToFavorites" class="btn btn-link" th:classappend="${isFavorited ? 'favorited' : ''}">
                        <i class="fa fa-heart" aria-hidden="true"></i>
                    </button>
                </form>
            </div>
            <button class="btn-custom mt-2 btn-view">Почати перегляд</button>
            <button class="btn-custom-subscribe mt-2 btn-view">Підписатись</button>
            <form id="addMangaForm" action="#" th:action="@{/manga/add-to-list}" th:object="${manga}" method="post" onsubmit="return false;">
                <div class="select-wrapper">
                    <select name="listType" id="listTypeSelect" class="form-select custom-select-lists">
                        <option value="" disabled th:selected="${!isInReadingList && !isInWantToReadList && !isInRecitedList && !isInReadStoppedList}">Додати до списку</option>
                        <option value="reading" th:selected="${isInReadingList}">Читаю</option>
                        <option value="want-read" th:selected="${isInWantToReadList}">У планах</option>
                        <option value="recited" th:selected="${isInRecitedList}">Прочитано</option>
                        <option value="read-stopped" th:selected="${isInReadStoppedList}">Кинуто</option>
                    </select>
                    <div id="icon-preview" class="icon-preview"></div>
                </div>
                <input type="hidden" name="mangaId" th:value="${manga.id}" />
            </form>
            <div class="info-block mt-2">
                <a href="/manga" class="link full-link">
                    <div class="info-item">
                        <p class="info-title">Тип:</p>
                        <span>Манга</span>
                    </div>
                </a>
                <a th:href="@{'/profile/' + ${manga.publishedBy.id}}" class="link full-link">
                    <div class="info-item">
                        <p class="info-title">Опублікував:</p>
                        <span th:text="${manga.publishedBy.userName}">Ім'я користувача</span>
                    </div>
                </a>
                <div class="info-item">
                    <p class="info-title">Рік виходу:</p>
                    <a th:href="@{'/search?q=' + ${manga.releaseYear} + '&type=releaseYear'}" class="link" th:text="${manga.releaseYear}"></a>
                </div>
                <div class="info-item">
                    <p class="info-title">Віковий рейтинг:</p>
                    <span th:text="${manga.adultContent} ? '18+' : 'Ні'"></span>
                </div>
                <div class="info-item">
                    <a th:if="${manga.author != null}" th:href="@{'/author/' + ${manga.author.id}}" class="link full-link">
                        <p class="info-title">Автор манги:</p>
                        <span th:text="${manga.author.name}"></span>
                    </a>
                    <p th:unless="${manga.author != null}" class="info-title">Автор манги:</p>
                    <span th:unless="${manga.author != null}">Невизначено</span>
                </div>
                <div class="info-item">
                    <p class="info-title">Статус манги:</p>
                    <a th:href="@{'/search?q=' + ${manga.mangaStatus} + '&type=mangaStatus'}" class="link" th:text="${translatedMangaStatus}"></a>
                </div>
                <div class="info-item">
                    <p class="info-title">Завантажено глав:</p>
                    <span th:text="${chapterCount}"></span>
                </div>
            </div>
        </div>
        <div class="right-block">
            <div class="title-rating">
                <h2 th:text="${manga.mangaName}"></h2>
                <div class="rating-container mb-2 open-rating-btn">
                    <div class="stars">
                        <i class="fa fa-star" aria-hidden="true"></i>
                        <span th:text="${#numbers.formatDecimal(manga.averageRating, 1, 'POINT', 2, 'COMMA')}" style="font-size: 18px;">0.00</span>
                        <span style="color: gray;">/ <span th:text="${manga.totalRatings}">0</span></span>
                    </div>
                    <button id="rateButton" class="rate-button">✭ Оцінити</button>
                </div>
                <div id="ratingPanel" class="rating-panel">
                    <button class="close-panel" aria-label="Закрыть">&times;</button>
                    <h3>Оцінити мангу</h3>
                    <form id="ratingForm" method="post" th:action="@{/rate-manga}" onsubmit="return false;">
                        <div class="rating-stars">
                            <i class="fa fa-star" data-value="1" aria-hidden="true"></i>
                            <i class="fa fa-star" data-value="2" aria-hidden="true"></i>
                            <i class="fa fa-star" data-value="3" aria-hidden="true"></i>
                            <i class="fa fa-star" data-value="4" aria-hidden="true"></i>
                            <i class="fa fa-star" data-value="5" aria-hidden="true"></i>
                        </div>
                        <input type="hidden" id="ratingInput" name="rating">
                        <input type="hidden" id="mangaIdInput" name="mangaId" th:value="${manga.id}">
                        <input type="hidden" id="userIdInput" name="userId" th:value="${user.id}">
                    </form>
                    <div id="userRating" class="user-rating mb-2">
                        <span th:if="${ratingValue != null}"></span>
                        <span id="ratingValue" th:text="${ratingValue != null ? ratingValue : ''}"></span>
                    </div>
                    <form id="removeRatingForm" method="post" th:action="@{/remove-rating}">
                        <input type="hidden" id="removeMangaIdInput" name="mangaId" th:value="${manga.id}">
                        <input type="hidden" id="removeUserIdInput" name="userId" th:value="${user.id}">
                        <div id="removeRatingContainer" th:if="${ratingValue != null}">
                            <button type="submit" id="removeRatingButton" class="remove-rating-button">Видалити оцінку</button>
                        </div>
                    </form>
                </div>
                <div id="overlay" class="overlay"></div>
            </div>
            <div class="bg-nav-tabs">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="info-tab" data-bs-toggle="tab" href="#info" role="tab" aria-controls="info" aria-selected="true">Інформація</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="chapters-tab" data-bs-toggle="tab" href="#chapters" role="tab" aria-controls="chapters" aria-selected="false">Глави</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="comments-tab" data-bs-toggle="tab" href="#comments" role="tab" aria-controls="comments" aria-selected="false">Коментарі</a>
                    </li>
                    <li th:if="${#authorization.expression('isAuthenticated()')} and (${#authentication.authorities[0].authority == 'ADMIN'} or ${#authentication.authorities[0].authority == 'MangaModerator'})" class="nav-item ms-3 admin-panel">
                        <button class="btn btn-custom-admin-panel" type="button" id="adminDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Меню Автора
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                            <li>
                                <a class="dropdown-item" th:href="@{/manga/{mangaId}/chapter/add(mangaId=${manga.id})}">
                                    <i class="fa fa-plus" aria-hidden="true"></i> Додати главу
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" th:href="@{/manga/edit/{id}(id=${id})}">
                                    <i class="fa fa-edit" aria-hidden="true"></i> Редагувати
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" th:onclick="'confirmDeleteManga(event, ' + ${manga.id} + ')'">
                                    <i class="fa fa-trash" aria-hidden="true"></i> Видалити
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                        <div class="forMobile">
                            <div class="mobile-img-container">
                                <img th:src="${manga.mangaPosterImg}" alt="Main Manga Image">
                                <form id="addMangaFavoritesForm-mobile" action="#" th:action="@{/manga/add-to-favorites}" method="post" onsubmit="return false;">
                                    <input type="hidden" name="mangaId" th:value="${manga.id}" />
                                    <button type="submit" id="addToFavorites-mobile" class="btn btn-link" th:classappend="${isFavorited ? 'favorited' : ''}">
                                        <i class="fa fa-heart" aria-hidden="true"></i>
                                    </button>
                                </form>
                            </div>
                            <div class="info-block-mobile">
                                <div class="info-item">
                                    <p class="info-title">Тип:</p>
                                    <span>Манга</span>
                                </div>
                                <div class="info-item">
                                    <p class="info-title">Рік виходу:</p>
                                    <a th:href="@{'/search?q=' + ${manga.releaseYear} + '&type=releaseYear'}" class="link" th:text="${manga.releaseYear}"></a>
                                </div>
                                <div class="info-item">
                                    <p class="info-title">Віковий рейтинг:</p>
                                    <span th:text="${manga.adultContent} ? '18+' : 'Ні'"></span>
                                </div>
                                <div class="info-item">
                                    <p class="info-title">Автор манги:</p>
                                    <span th:text="${manga.author != null ? manga.author.name : 'Невизначено'}"></span>
                                </div>
                                <div class="info-item">
                                    <p class="info-title">Статус манги:</p>
                                    <a th:href="@{'/search?q=' + ${manga.mangaStatus} + '&type=mangaStatus'}" class="link" th:text="${translatedMangaStatus}"></a>
                                </div>
                                <div class="info-item">
                                    <p class="info-title">Завантажено глав:</p>
                                    <span th:text="${chapterCount}"></span>
                                </div>
                            </div>
                            <div class="actions-menu-mobile">
                                <div class="button-group">
                                    <button class="btn-custom-subscribe btn-view">Підписатись</button>
                                </div>
                                <form id="addMangaForm-mobile" action="#" th:action="@{/manga/add-to-list}" th:object="${manga}" method="post" onsubmit="return false;">
                                    <div class="select-wrapper ">
                                        <select name="listType" id="listTypeSelect-mobile" class="form-select custom-select-lists custom-select-lists-mobile">
                                            <option value="" disabled th:selected="${!isInReadingList && !isInWantToReadList && !isInRecitedList && !isInReadStoppedList}">Додати до списку</option>
                                            <option value="reading" th:selected="${isInReadingList}">Читаю</option>
                                            <option value="want-read" th:selected="${isInWantToReadList}">У планах</option>
                                            <option value="recited" th:selected="${isInRecitedList}">Прочитано</option>
                                            <option value="read-stopped" th:selected="${isInReadStoppedList}">Кинуто</option>
                                        </select>
                                        <div id="icon-preview-mobile" class="icon-preview"></div>
                                    </div>
                                    <input type="hidden" name="mangaId" th:value="${manga.id}" />
                                </form>
                            </div>
                        </div>
                        <p style="color:gray;">Повний Опис</p>
                        <p th:text="${manga.mangaDescription}"></p>
                        <hr>
                        <p style="color:gray;">Жанри & Категорії</p>
                        <div class="genres">
                            <span th:each="genre : ${manga.genres}" th:text="${genre.genreName}"></span>
                        </div>
                        <hr>
                        <div th:if="${not #lists.isEmpty(relatedMangas)}">
                                <div class="related">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <p style="color: gray;">Пов'язані</p>
                                        <div class="carousel-controls">
                                            <button class="btn btn-link carousel-control-prev" type="button" data-bs-target="#mangaCarouselRelated" data-bs-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Previous</span>
                                            </button>
                                            <button class="btn btn-link carousel-control-next" type="button" data-bs-target="#mangaCarouselRelated" data-bs-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Next</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="mangaCarouselRelated" class="carousel slide">
                                        <div id="mangaCarouselRelatedInner" class="carousel-inner">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <div th:if="${not #lists.isEmpty(similarMangas)}">
                                <div class="related">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <p style="color: gray;">Схожі</p>
                                        <div class="carousel-controls">
                                            <button class="btn btn-link carousel-control-prev" type="button" data-bs-target="#mangaCarouselSimilar" data-bs-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Previous</span>
                                            </button>
                                            <button class="btn btn-link carousel-control-next" type="button" data-bs-target="#mangaCarouselSimilar" data-bs-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Next</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="mangaCarouselSimilar" class="carousel slide">
                                        <div id="mangaCarouselSimilarInner" class="carousel-inner">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <div class="charts-wrapper">
                            <div class="chart-section">
                                <h2>Списки</h2>
                                <div class="chart-container" id="chart-containerLists"></div>
                            </div>

                            <div class="chart-section">
                                <h2>Оцінки</h2>
                                <div class="chart-container" id="chart-containerGrades"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="chapters" role="tabpanel" aria-labelledby="chapters-tab">
                            <div class="chapter-list">
                                <div th:if="${#lists.isEmpty(chapters)}" class="alert alert-info">
                                    <i class="fa-regular fa-face-sad-tear" style="font-size: 1.5rem;"></i>
                                    <span>Поки що не було додано глав для цієї манги.</span>
                                </div>
                                <div th:unless="${#lists.isEmpty(chapters)}" class="d-flex justify-content-between align-items-center mb-3" style="padding-left: 14px;">
                                    <button id="sortChapters" class="btn btn-outline-primary">
                                        <i id="sortIcon" class="fas fa-sort-amount-down"></i> Сортувати
                                    </button>
                                </div>
                                <ul id="chaptersList" class="list-group">
                                    <li th:each="chapter : ${chapters}" class="list-group-item mb-1" th:data-date="${chapter.creationTime}">
                                        <div th:if="${#authentication.authorities[0].authority == 'ADMIN' or #authentication.authorities[0].authority == 'MangaModerator'}" class="d-flex flex-column">
                                            <span>
                                                <a th:href="@{/manga/{mangaId}/chapter/{chapterId}(mangaId=${manga.id}, chapterId=${chapter.id})}" class="chapter-title text-decoration-none" style="color:#ce86ff;">
                                                    <span class="chapter-title" th:text="${chapter.title}"></span>
                                                </a>
                                            </span>
                                            <div class="d-flex align-items-center">
                                            <span style="font-size:14px; color:gray;">
                                                <span th:text="${#temporals.format(chapter.creationTime, 'dd MMM yyyy р.', new java.util.Locale('uk', 'UA'))}"></span>
                                                <span style="margin: 0 5px;">|</span>
                                                <!--<i class="fas fa-user" style="margin-right: 5px;"></i>!-->
                                                <span>
                                                    <a class="user-added-chapter" th:href="@{/profile/{userId}(userId=${chapter.user.id})}">
                                                        <img th:src="${chapter.user.profilePicture}" alt="Profile Picture" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; margin-right: 5px;">
                                                        <span th:text="${chapter.user.userName}"></span>
                                                    </a>
                                                </span>
                                            </span>
                                                <div class="ms-auto d-flex align-items-center">
                                                    <a th:href="@{/manga/{mangaId}/chapter/edit/{chapterId}(mangaId=${manga.id}, chapterId=${chapter.id})}" class="ms-3">
                                                        <i class="fas fas-admin fa-edit"></i>
                                                    </a>
                                                    <form th:action="@{/manga/{mangaId}/chapter/delete/{chapterId}(mangaId=${manga.id}, chapterId=${chapter.id})}" method="post" class="d-inline ms-3">
                                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                        <button type="submit" class="btn btn-delete p-0">
                                                            <i class="fas fas-admin fa-trash-alt"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div th:unless="${#authentication.authorities[0].authority == 'ADMIN' or #authentication.authorities[0].authority == 'MangaModerator'}" class="d-flex justify-content-between align-items-center">
                                            <a th:href="@{/manga/{mangaId}/chapter/{chapterId}(mangaId=${manga.id}, chapterId=${chapter.id})}" class="chapter-title text-decoration-none" style="color:#ce86ff;">
                                                <span th:text="${chapter.title}"></span>
                                            </a>
                                            <span style="font-size:14px; color:gray;">
                                                <span>
                                                    <a class="user-added-chapter" th:href="@{/profile/{userId}(userId=${chapter.user.id})}">
                                                        <img th:src="${chapter.user.profilePicture}" alt="Profile Picture" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; margin-right: 5px;">
                                                        <span th:text="${chapter.user.userName}"></span>
                                                    </a>
                                                </span>
                                                <span style="margin: 0 5px;">|</span>
                                                <span th:text="${#temporals.format(chapter.creationTime, 'dd MMM yyyy р.', new java.util.Locale('uk', 'UA'))}"></span>
                                            </span>
                                        </div>
                                    </li>
                                </ul>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="comments" role="tabpanel" aria-labelledby="comments-tab" th:data-manga-id="${manga.id}" th:data-current-user-id="${user.id}">
                            <div class="comment-controls">
                                <form id="add-comment-form" th:action="@{/manga/{mangaId}/add-comment(mangaId=${manga.id})}" method="post">
                                    <div class="form-group">
                                        <textarea id="comment-text" name="text" class="form-control" rows="4" placeholder="Залишити коментар..." required></textarea>
                                    </div>
                                </form>
                                <div class="controls-container">
                                    <div class="dropdown dropdown-sort">
                                        <button class="btn dropdown-toggle view-btn"  style="background-color:#282828; color:#fff;" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                            Сортувати: <span id="dropdownMenuText">За оновленням</span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-sortBy custom-mt" aria-labelledby="dropdownMenuButton">
                                            <li><a class="dropdown-item active" href="#" data-sort="byNew">За оновленням</a></li>
                                            <li><a class="dropdown-item" href="#" data-sort="byRating">За рейтингом</a></li>
                                        </ul>
                                    </div>
                                    <button id="submit-comment" form="add-comment-form" type="submit" class="btn btn-primary">
                                        <i class="fa-solid fa-paper-plane"></i> Надіслати
                                    </button>
                                </div>
                            </div>
                            <ul id="comments-list" class="list-group mt-3" style="padding:15px;"></ul>
                            <div id="loading-comments-for-manga" class="loading-comments-for-manga" style="display: none;">
                                <div class="loading">
                                    <i class="fa-solid fa-spinner fa-spin"></i> Завантаження...
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:if="${notificationMessage}" class="alert alert-success alert-dismissible fade show hide-delay fixed-right" role="alert">
    <span th:text="${notificationMessage}"></span>
</div>
</div>
<footer th:insert="~{/blocks/footer :: footer}"></footer>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="/js/loader-spinner.js"></script>
<script src="/js/listTypeSelect.js"></script>
<script src="/js/burger-menu.js"></script>
<script src="/js/confirmDelete.js"></script>
<script src="/js/manga-details.js"></script>
<script src="/js/carousel-details.js"></script>
<script src="/js/manga-details-comments.js"></script>
<script th:inline="javascript">
    window.relatedMangas = /*[[${relatedMangas}]]*/ [];
    window.similarMangas = /*[[${similarMangas}]]*/ [];
</script>
<script th:inline="javascript">
    window.countReading = /*[[${countReading}]]*/ 0;
    window.countWantToRead = /*[[${countWantToRead}]]*/ 0;
    window.countStoppedReading = /*[[${countStoppedReading}]]*/ 0;
    window.countRecited = /*[[${countRecited}]]*/ 0;
    window.countFavorites = /*[[${countFavorites}]]*/ 0;

    window.countOneStar = /*[[${countOneStar}]]*/ 0;
    window.countTwoStar = /*[[${countTwoStar}]]*/ 0;
    window.countThreeStar = /*[[${countThreeStar}]]*/ 0;
    window.countFourStar = /*[[${countFourStar}]]*/ 0;
    window.countFiveStar = /*[[${countFiveStar}]]*/ 0;
</script>
<script th:unless="${#lists.isEmpty(chapters)}" src="/js/manga-details-chapter-sort.js"></script>
<script src="/js/manga-details-statistics.js"></script>
<script th:if="${manga.adultContent and not userSettings.adultContentAgreement}" src="/js/adultContentAlert.js"></script>
</body>
</html>
